% Mybiblatex4.sty -- Authoryear-focused BibLaTeX profile (Japanese/Western mix with revised author-year formatting)
\ProvidesFile{Mybiblatex4.sty}[2025/10/02 Authoryear mixed-language BibLaTeX profile v4]

\RequirePackage{etoolbox}

% 翻訳書で名・姓を中点で結ぶ際のデリミタ
\newcommand*{\TransJPNNameDelim}{・}
\newcommand*{\BibJapaneseVolumeSuffix}{巻}
\newcommand*{\BibJapaneseNumberSuffix}{号}
\newcommand*{\BibJapanesePageSuffix}{頁}
\newcommand*{\BibJapaneseNameSeparator}{、}

\AddToHook{package/biblatex/after}{%
  \DeclareSortingTemplate{lnyt}{%
    \sort[direction=ascending]{\field{presort}}%
    \sort[direction=ascending]{\field{sortkey}}%
    \sort[direction=ascending]{\field{usera}}%
    \sort[direction=ascending]{\field{sortname}}%
    \sort[direction=ascending]{\field{author}}%
    \sort[direction=ascending]{\field{editor}}%
    \sort[direction=ascending]{\field{translator}}%
    \sort[direction=ascending]{\field{sortyear}}%
    \sort[direction=ascending]{\field{year}}%
    \sort[direction=ascending]{\field{sorttitle}}%
    \sort[direction=ascending]{\field{title}}%
  }%
  \ExecuteBibliographyOptions{sorting=lnyt,dashed=true}%
  \providecommand*{\BibHangingIndent}{1.5\zw}%
  \setlength{\bibhang}{\BibHangingIndent}%
  \DeclareSourcemap{% 
    \maps[datatype=bibtex]{%
      \map{% 
        \step[fieldset=abstract, null]%
        \step[fieldset=annotation, null]%
        \step[fieldset=keywords, null]%
        \step[fieldset=note, null]%
        \step[fieldset=addendum, null]%
        \step[fieldset=urldate, null]%
      }%
      \map{% 
        \step[fieldsource=sortkey, match=\regexp{.+}, final]%
        \step[fieldsource=usera, match=\regexp{.+}, fieldset=sortkey, origfieldval]%
      }%
      \map{% 
        \step[fieldsource=presort, match=\regexp{.+}, final]%
        \step[fieldsource=langid, match=\regexp{(?i)(english|american|british|australian|canadian|german|french|italian|spanish)}, fieldset=presort, fieldvalue={A}]%
      }%
      \map{% 
        \step[fieldsource=presort, match=\regexp{.+}, final]%
        \step[fieldsource=langid, match=transJPN, fieldset=presort, fieldvalue={B}]%
      }%
      \map{% 
        \step[fieldsource=presort, match=\regexp{.+}, final]%
        \step[fieldsource=langid, match=transJPNfamily, fieldset=presort, fieldvalue={B}]%
      }%
      \map{% 
        \step[fieldsource=presort, match=\regexp{.+}, final]%
        \step[fieldsource=langid, match=\regexp{(?i)japanese}, fieldset=presort, fieldvalue={C}]%
      }%
      \map{% 
        \step[fieldsource=presort, match=\regexp{.+}, final]%
        \step[fieldset=presort, fieldvalue={D}]%
      }%
    }%
  }%

  \AtEveryBibitem{% 
    \global\BibMononymAuthorfalse
    \clearfield{abstract}%
    \clearfield{annotation}%
    \clearfield{note}%
    \clearfield{addendum}%
    \clearfield{urldate}%
    \clearlist{keywords}%
  }%

  \providecommand*{\mkbibandothers}{\bibstring{andothers}}%
  \providecommand*{\mkbibnameandothers}{\bibstring{nameandothers}}%
  \renewcommand*{\mkbibandothers}{\IfBibEntryWestern{\bibstring{andothers}}{ほか}}%
  \renewcommand*{\mkbibnameandothers}{\IfBibEntryWestern{\bibstring{andothers}}{ほか}}%
  \renewbibmacro*{name:andothers}{%
    \ifboolexpr{% 
      test {\ifnumequal{\value{listcount}}{\value{liststop}}}%
      and test \ifmorenames
    }{\andothersdelim\mkbibnameandothers}{}%
  }%

  % Western 判定 (langid)
  \newcommand*{\IfBibEntryWestern}[2]{%
    \ifboolexpr{% 
      test {\iffieldequalstr{langid}{english}}%
      or test {\iffieldequalstr{langid}{English}}%
      or test {\iffieldequalstr{langid}{English (英語)}}%
      or test {\iffieldequalstr{langid}{american}}%
      or test {\iffieldequalstr{langid}{American}}%
      or test {\iffieldequalstr{langid}{british}}%
      or test {\iffieldequalstr{langid}{British}}%
      or test {\iffieldequalstr{langid}{australian}}%
      or test {\iffieldequalstr{langid}{Australian}}%
      or test {\iffieldequalstr{langid}{canadian}}%
      or test {\iffieldequalstr{langid}{Canadian}}%
      or test {\iffieldequalstr{langid}{german}}%
      or test {\iffieldequalstr{langid}{German}}%
      or test {\iffieldequalstr{langid}{German (ドイツ語)}}%
      or test {\iffieldequalstr{langid}{french}}%
      or test {\iffieldequalstr{langid}{French}}%
      or test {\iffieldequalstr{langid}{italian}}%
      or test {\iffieldequalstr{langid}{Italian}}%
      or test {\iffieldequalstr{langid}{spanish}}%
      or test {\iffieldequalstr{langid}{Spanish}}%
    }{#1}{#2}%
  }

  % 翻訳書 (langid=transJPN)
  \newcommand*{\IfBibEntryTransJapanese}[2]{%
    \ifboolexpr{test {\iffieldequalstr{langid}{transJPN}}}{#1}{#2}%
  }

  % 翻訳書 (langid=transJPNfamily)
  \newcommand*{\IfBibEntryTransJapaneseSurnameFirst}[2]{%
    \ifboolexpr{test {\iffieldequalstr{langid}{transJPNfamily}}}{#1}{#2}%
  }

  % 日本語 (langid=Japanese/japanese)
  \newcommand*{\IfBibEntryJapanese}[2]{%
    \ifboolexpr{% 
      test {\iffieldequalstr{langid}{Japanese}}%
      or test {\iffieldequalstr{langid}{japanese}}%
    }{#1}{#2}%
  }

  \DeclareNameFormat{familyonly}{%
    \IfBibEntryWestern{% 
      \ifblank{\namepartfamily}{%
        \ifblank{\namepartgiven}{}{\namepartgiven}%
      }{% 
        \namepartfamily%
      }%
    }{% 
      \ifblank{\namepartfamily}{%
        \ifblank{\namepartgiven}{}{\namepartgiven}%
      }{% 
        \namepartfamily%
      }%
    }%
    \usebibmacro{name:andothers}%
  }

  \DeclareNameFormat{author}{%
    \BibMarkSingleName
    \IfBibEntryWestern{% 
      \ifnumequal{\value{listcount}}{1}{%
        \ifblank{\namepartfamily}{%
          \ifblank{\namepartgiven}{}{\namepartgiven}%
        }{% 
          \namepartfamily%
          \ifblank{\namepartgiven}{}{\addcomma\space\namepartgiven}%
        }%
      }{% 
        \ifnumequal{\value{listcount}}{\value{liststop}}{\addcomma\space and\space}{\addcomma\space}%
        \ifblank{\namepartgiven}{%
          \ifblank{\namepartfamily}{} {\namepartfamily}%
        }{% 
          \namepartgiven%
          \ifblank{\namepartfamily}{}{\space\namepartfamily}%
        }%
      }%
    }{% 
      \IfBibEntryTransJapanese{% 
        \ifnumequal{\value{listcount}}{1}{} {\BibJapaneseNameSeparator}%
        \ifblank{\namepartfamily}{%
          \ifblank{\namepartgiven}{}{\namepartgiven}%
        }{% 
          \ifblank{\namepartgiven}{\namepartfamily}{\namepartgiven\TransJPNNameDelim\namepartfamily}%
        }%
      }{% 
        \IfBibEntryTransJapaneseSurnameFirst{% 
          \ifnumequal{\value{listcount}}{1}{} {\BibJapaneseNameSeparator}%
          \ifblank{\namepartfamily}{%
            \ifblank{\namepartgiven}{}{\namepartgiven}%
          }{% 
            \namepartfamily%
            \ifblank{\namepartgiven}{}{\addcomma\space\namepartgiven}%
          }%
        }{% 
          \ifnumequal{\value{listcount}}{1}{\hspace{-1pt}}{\BibJapaneseNameSeparator}%
          \ifblank{\namepartfamily}{%
            \ifblank{\namepartgiven}{}{\namepartgiven}%
          }{% 
            \namepartfamily%
            \ifblank{\namepartgiven}{}{\unskip\namepartgiven}%
          }%
        }%
      }%
    }%
    \usebibmacro{name:andothers}%
  }

  \DeclareNameAlias{editor}{author}%
  \DeclareNameFormat{translator}{%
    \BibMarkSingleName
    \IfBibEntryWestern{% 
      \ifnumequal{\value{listcount}}{1}{%
        \ifblank{\namepartfamily}{%
          \ifblank{\namepartgiven}{}{\namepartgiven}%
        }{% 
          \namepartfamily%
          \ifblank{\namepartgiven}{}{\addcomma\space\namepartgiven}%
        }%
      }{% 
        \ifnumequal{\value{listcount}}{\value{liststop}}{\addcomma\space and\space}{\addcomma\space}%
        \ifblank{\namepartgiven}{%
          \ifblank{\namepartfamily}{} {\namepartfamily}%
        }{% 
          \namepartgiven%
          \ifblank{\namepartfamily}{}{\space\namepartfamily}%
        }%
      }%
    }{% 
      \ifnumequal{\value{listcount}}{1}{} {\BibJapaneseNameSeparator}%
      \ifblank{\namepartfamily}{%
        \ifblank{\namepartgiven}{}{\namepartgiven}%
      }{% 
        \namepartfamily%
        \ifblank{\namepartgiven}{}{\unskip\namepartgiven}%
      }%
    }%
    \usebibmacro{name:andothers}%
    \ifboolexpr{test {\ifnumequal{\value{listcount}}{\value{liststop}}}}{% 
      \IfBibEntryWestern{}{訳}}%
    {}%
  }
  \DeclareNameAlias{bytranslator}{translator}%

  \renewbibmacro*{bytranslator}{%
    \ifnameundef{translator}{}{% 
      \IfBibEntryWestern{% 
        \printtext{trans\adddotspace by\space}\printnames[bytranslator]{translator}%
      }{% 
        \printnames[bytranslator]{translator}%
      }%
    }%
  }%

  \renewbibmacro*{bytranslator+others}{%
    \ifnameundef{translator}{}{% 
      \IfBibEntryWestern{% 
        \printtext{trans\adddotspace by\space}\printnames[bytranslator]{translator}%
      }{% 
        \printnames[bytranslator]{translator}%
      }%
      \clearname{translator}%
      \newunit
    }%
    \usebibmacro{withothers}%
  }%

  \DeclareNameAlias{labelname}{familyonly}
  \DeclareNameAlias{label}{familyonly}
  \DeclareNameAlias{shortauthor}{familyonly}
  \DeclareNameAlias{shorteditor}{familyonly}
  \DeclareNameAlias{shorttranslator}{familyonly}
  \DeclareNameAlias{citeauthor}{familyonly}

  \renewbibmacro*{author/editor+others}{%
    \ifnameundef{author}{%
      \ifnameundef{editor}{%
        \global\undef\bbx@lasthash
        \usebibmacro{labeltitle}%
      }{% 
        \usebibmacro{bbx:dashcheck}{\bibnamedash}{%
          \usebibmacro{bbx:savehash}%
          \printnames{editor}%
        }%
        \setunit{\addspace}%
        \usebibmacro{editor+othersstrg}%
      }%
    }{% 
      \usebibmacro{bbx:dashcheck}{\bibnamedash}{%
        \usebibmacro{bbx:savehash}%
        \printnames{author}%
      }%
    }%
  }

  \newif\ifBibGroupPrintedWestern
  \newif\ifBibGroupPrintedTranslated
  \newif\ifBibGroupPrintedJapanese
  \newif\ifBibGroupPrintedOther
  \newif\ifBibGroupPrintedAny
  \newif\ifBibMononymAuthor
  \newif\ifBibSuppressYearPunct

  \newcommand*{\BibMarkSingleName}{%
    \ifnumequal{\value{listcount}}{1}{%
      \ifmorenames{}{% 
        \ifdefvoid{\namepartfamily}{%
          \global\BibMononymAuthortrue
        }{% 
          \ifdefvoid{\namepartgiven}{%
            \global\BibMononymAuthortrue
          }{}%
        }%
      }%
    }{}%
  }

  \newcommand*{\BibAuthorYearDelimiter}{%
    \ifBibMononymAuthor
      \PackageInfo{Mybiblatex4}{BibAuthorYearDelimiter -> mononym case}%
    \else
      \PackageInfo{Mybiblatex4}{BibAuthorYearDelimiter -> default case}%
      \global\BibMononymAuthorfalse
    \fi
    \setunit{\addspace}%
    \global\BibSuppressYearPuncttrue
    \newunit
  }

  \let\BibOriginalNewUnitPunct\newunitpunct
  \renewcommand*{\newunitpunct}{%
    \ifBibMononymAuthor
      \PackageInfo{Mybiblatex4}{newunitpunct -> mononym override}%
      \global\BibMononymAuthorfalse
      \global\BibSuppressYearPunctfalse
      \addperiod\space
    \else
      \ifBibSuppressYearPunct
        \PackageInfo{Mybiblatex4}{newunitpunct -> year spacer}%
        \global\BibSuppressYearPunctfalse
        \addspace
      \else
        \PackageInfo{Mybiblatex4}{newunitpunct -> fallback}%
        \BibOriginalNewUnitPunct
      \fi
    \fi
  }

  \providecommand*{\BibGroupHeadingWestern}{欧米文献}
  \providecommand*{\BibGroupHeadingTranslated}{翻訳文献}
  \providecommand*{\BibGroupHeadingJapanese}{日本語文献}
  \providecommand*{\BibGroupHeadingOther}{その他}

  \newcommand*{\PrintBibGroupHeading}[1]{%
    \ifBibGroupPrintedAny\par\addvspace{1.2\baselineskip}\fi
    {\large\bfseries #1}\par\nobreak\addvspace{0.6\baselineskip}%
    \global\BibGroupPrintedAnytrue
  }

  \newcommand*{\MaybePrintBibGroupHeading}{%
    \iffieldundef{presort}{}{%
      \ifboolexpr{test {\iffieldequalstr{presort}{A}}}{%
        \ifBibGroupPrintedWestern\else
          \PrintBibGroupHeading{\BibGroupHeadingWestern}%
          \global\BibGroupPrintedWesterntrue
        \fi
      }{}
      \ifboolexpr{test {\iffieldequalstr{presort}{B}}}{%
        \ifBibGroupPrintedTranslated\else
          \PrintBibGroupHeading{\BibGroupHeadingTranslated}%
          \global\BibGroupPrintedTranslatedtrue
        \fi
      }{}
      \ifboolexpr{test {\iffieldequalstr{presort}{C}}}{%
        \ifBibGroupPrintedJapanese\else
          \PrintBibGroupHeading{\BibGroupHeadingJapanese}%
          \global\BibGroupPrintedJapanesetrue
        \fi
      }{}
      \ifboolexpr{test {\iffieldequalstr{presort}{D}}}{%
        \ifBibGroupPrintedOther\else
          \PrintBibGroupHeading{\BibGroupHeadingOther}%
          \global\BibGroupPrintedOthertrue
        \fi
      }{}
    }%
  }

  \AtBeginBibliography{% 
    \global\BibGroupPrintedWesternfalse
    \global\BibGroupPrintedTranslatedfalse
    \global\BibGroupPrintedJapanesefalse
    \global\BibGroupPrintedOtherfalse
    \global\BibGroupPrintedAnyfalse
  }

  \pretocmd{\bibitem}{\MaybePrintBibGroupHeading}{}{}

  \defbibheading{bibliography}{\section*{文献一覧}}

  \renewcommand*{\BibPrintYear}{%
    \printtext{%
      \IfBibEntryWestern{(}{（}%
      \printlabeldateextra
      \IfBibEntryWestern{)}{）}%
    }%
  }

  \DeclareFieldFormat[book]{title}{\IfBibEntryWestern{\mkbibemph{#1}}{『#1』}}
  \DeclareFieldFormat[incollection]{title}{\IfBibEntryWestern{\mkbibquote{#1\isdot}}{「#1」}}
  \DeclareFieldFormat[article]{title}{\IfBibEntryWestern{\mkbibquote{#1\isdot}}{「#1」}}
  \DeclareFieldFormat[incollection]{booktitle}{\IfBibEntryWestern{\mkbibemph{#1}}{『#1』}}
  \DeclareFieldFormat[article]{journaltitle}{\IfBibEntryWestern{\mkbibemph{#1}}{『#1』}}

  \DeclareDelimFormat[bib,biblist]{multinamedelim}{%
    \IfBibEntryWestern{\addcomma\space}{、}%
  }
  \DeclareDelimFormat[bib,biblist]{finalnamedelim}{%
    \IfBibEntryWestern{\addcomma\space and\space}{、}%
  }
  \DeclareDelimFormat[cite]{multinamedelim}{%
    \IfBibEntryWestern{\addcomma\space}{、}%
  }
  \DeclareDelimFormat[cite]{finalnamedelim}{%
    \IfBibEntryWestern{\addcomma\space and\space}{、}%
  }
  \DeclareDelimFormat{nameyeardelim}{\addcomma\space}
  \DeclareDelimFormat[cite]{nameyeardelim}{\addcomma\space}

  \renewcommand*{\postnotedelim}{\addcomma\space}
  \renewcommand*{\prenotedelim}{\addcomma\space}

  \AtBeginDocument{% 
    \ifcsundef{blx@bibmacro@textcite:labelyear+extrayear}{%
      \newbibmacro*{textcite:labelyear+extrayear}{%
        \printtext{\mkbibparens{\printlabeldateextra}}%
      }%
    }{% 
      \renewbibmacro*{textcite:labelyear+extrayear}{%
        \printtext{\mkbibparens{\printlabeldateextra}}%
      }%
    }%
  }

  \DeclareBibliographyDriver{book}{%
    \usebibmacro{bibindex}%
    \usebibmacro{begentry}%
    \usebibmacro{author/editor+others}%
    \BibAuthorYearDelimiter
    \BibPrintYear%
    \IfBibEntryWestern{% 
      \newunit\newblock
      \printfield{title}%
      \ifnameundef{translator}{}{% 
        \newunit\newblock
        \usebibmacro{bytranslator}%
      }%
      \newunit\newblock
      \printlist{location}%
      \iflistundef{location}{}{% 
        \setunit{\addcolon\space}%
      }%
      \printlist{publisher}%
    }{% 
      \newunit\newblock
      \printfield{title}%
      \ifnameundef{translator}{}{% 
        \setunit{}%
        \usebibmacro{bytranslator}%
        \setunit{、}%
      }%
      \ifnameundef{translator}{\setunit{}}{}%
      \printlist{publisher}%
    }%
    \addperiod%
    \finentry%
  }

  \DeclareBibliographyDriver{article}{%
    \usebibmacro{bibindex}%
    \usebibmacro{begentry}%
    \usebibmacro{author/editor+others}%
    \BibAuthorYearDelimiter
    \BibPrintYear%
    \IfBibEntryWestern{% 
      \newunit\newblock
      \printfield{title}%
      \newunit\newblock
      \printfield{journaltitle}%
      \setunit{\addspace}%
      \printfield{volume}%
      \iffieldundef{number}{%
        \setunit{\addcolon\space}%
      }{% 
        \setunit{\space}%
        \printtext{\mkbibparens{\printfield{number}}}%
        \setunit{\addcolon\space}%
      }%
      \printfield{pages}%
    }{% 
      \newunit\newblock
      \printfield{title}%
      \setunit{}%
      \printfield{journaltitle}%
      \iffieldundef{volume}{}{% 
        \setunit{}%
        \printfield[noformat]{volume}\BibJapaneseVolumeSuffix%
      }%
      \iffieldundef{number}{}{% 
        \setunit{}%
        \printfield[noformat]{number}\BibJapaneseNumberSuffix%
      }%
      \setunit{、}%
      \printlist{publisher}%
      \iffieldundef{pages}{}{% 
        \setunit{、}%
        \printfield[noformat]{pages}\BibJapanesePageSuffix%
      }%
    }%
    \addperiod%
    \finentry%
  }

  \DeclareBibliographyDriver{incollection}{%
    \usebibmacro{bibindex}%
    \usebibmacro{begentry}%
    \usebibmacro{author/editor+others}%
    \BibAuthorYearDelimiter
    \BibPrintYear%
    \IfBibEntryWestern{% 
      \newunit\newblock
      \printfield{title}%
      \newunit\newblock
      \printtext{In\space}%
      \printfield{booktitle}%
      \ifnameundef{editor}{}{% 
        \setunit{\addcomma\space}%
        \printtext{\ifnumgreater{\value{editor}}{1}{eds.}{ed.}\space}%
        \printnames{editor}%
      }%
      \setunit{\addcomma\space}%
      \printfield{pages}%
      \newunit\newblock
      \printlist{location}%
      \iflistundef{location}{}{% 
        \setunit{\addcolon\space}%
      }%
      \printlist{publisher}%
    }{% 
      \newunit\newblock
      \printfield{title}%
      \ifnameundef{editor}{}{% 
        \setunit{}%
        \printnames{editor}編%
      }%
      \setunit{}%
      \printfield{booktitle}%
      \printtext{所収}%
      \setunit{、}%
      \printlist{publisher}%
      \iffieldundef{pages}{}{% 
        \setunit{、}%
        \printfield[noformat]{pages}\BibJapanesePageSuffix%
      }%
    }%
    \addperiod%
    \finentry%
  }

  \DeclareDelimFormat[bib,biblist]{revsdnamepunct}{\IfBibEntryWestern{\addcomma\space}{}}
}

% 参考文献著者ダッシュ調整（2025年9月29日）
\newcommand*{\BibDashStretchFactor}{8.0}
\newcommand*{\SetBibDashStretchFactor}[1]{\renewcommand*{\BibDashStretchFactor}{#1}}
\DeclareRobustCommand{\BibAuthorDash}{%
  \unskip
  \nobreak\hskip0em\relax
  \leavevmode
  \begingroup
    \scalebox{\BibDashStretchFactor}[1]{\textemdash}%
  \endgroup
  \nobreak
}
\AtBeginDocument{% 
  \renewcommand*{\bibnamedash}{\BibAuthorDash}%
}
